const { sql, getConnection } = require("../config/RapidoSeguro");

const pedidoModel = {
 /**
     * busca todos os pedidos e seus respectivos itens no banco de dados 
     * @async
     * @function buscarTodos
     * @returns {Promise<Array>} retorna uma lista com todos os pedidos e seus itens.
     * @throws mostra no console e propaga o erro caso a busca falhe
     */

    inserirPedido: async (idPedido, idCliente, dataPedido, tipoEntrega, distanciaEntrega, pesoKg, valorKm, valorKg, valorTotal) => {
        const pool = await getConnection();
    
        const transaction = new sql.Transaction(pool); // realiza uma transação no banco de dados
        await transaction.begin(); // inicia a transação
    
        try {
            const querySQL = `
                INSERT INTO Pedidos 
                    (idPedido, idCliente, dataPedido, tipoEntrega, distanciaEntrega, pesoKg, valorKm, valorKg, valorTotal)
                VALUES 
                    (@idPedido, @idCliente, @dataPedido, @tipoEntrega, @distanciaEntrega, @pesoKg, @valorKm, @valorKg, @valorTotal)
            `;
    
            await transaction.request()
                .input("idPedido", sql.UniqueIdentifier, idPedido)
                .input("idCliente", sql.UniqueIdentifier, idCliente)
                .input("dataPedido", sql.Date, dataPedido)
                .input("tipoEntrega", sql.VarChar(10), tipoEntrega)
                .input("distanciaEntrega", sql.Decimal(10, 2), distanciaEntrega)
                .input("pesoKg", sql.Decimal(10, 2), pesoKg)
                .input("valorKm", sql.Decimal(10, 2), valorKm)
                .input("valorKg", sql.Decimal(10, 2), valorKg)
                .input("valorTotal", sql.Decimal(10, 2), valorTotal)
                .query(querySQL);
    
            await transaction.commit(); // confirma a transação e salva no banco
            console.log("Pedido inserido com sucesso!");
    
        } catch (error) {
            await transaction.rollback(); // desfaz a transação em caso de erro
            console.error("Erro ao inserir pedido:", error);
            throw error;
        }
    },

    buscarUm: async (idPedido) => {
        try {

            const pool = await getConnection();

            const querySQL = "SELECT * FROM Pedidos WHERE idPedido = @idPedido";

            const result = await pool.request()
                .input("idPedido", sql.UniqueIdentifier, idPedido)
                .query(querySQL);

            return result.recordset;
        } catch (error) {
            console.error("Erro ao buscar o pedido", error);
            throw error;
        }
    },

    buscarTodos: async () => {
        try {
            const pool = await getConnection();
    
            const querySQL = `
                SELECT 
                    PD.idPedido,
                    CL.nomeCliente,
                    PD.dataPedido,
                    PD.tipoEntrega,
                    PD.distanciaEntrega,
                    PD.pesoKg,
                    PD.valorKm,
                    PD.valorKg,
                    PD.valorTotal
                FROM Pedidos PD
                INNER JOIN Clientes CL
                    ON CL.idCliente = PD.idCliente
            `;
    
            const result = await pool.request().query(querySQL);
    
            return result.recordset;
    
        } catch (error) {
            console.error("Erro ao buscar pedidos:", error);
            throw error;
        }
    },
    
    atualizarPedido: async (idPedido, idCliente, dataPedido, tipoEntrega, distanciaEntrega, pesoKg, valorKm, valorKg, valorTotal) => {
        try {
            const pool = await getConnection();
    
            const querySQL = `
                UPDATE Pedidos
                SET 
                    idCliente = @idCliente,
                    dataPedido = @dataPedido,
                    tipoEntrega = @tipoEntrega,
                    distanciaEntrega = @distanciaEntrega,
                    pesoKg = @pesoKg,
                    valorKm = @valorKm,
                    valorKg = @valorKg,
                    valorTotal = @valorTotal
                WHERE idPedido = @idPedido
            `;
    
            await pool.request()
                .input("idPedido", sql.UniqueIdentifier, idPedido)
                .input("idCliente", sql.UniqueIdentifier, idCliente)
                .input("dataPedido", sql.Date, dataPedido)
                .input("tipoEntrega", sql.VarChar, tipoEntrega)
                .input("distanciaEntrega", sql.Decimal(10, 2), distanciaEntrega)
                .input("pesoKg", sql.Decimal(10, 2), pesoKg)
                .input("valorKm", sql.Decimal(10, 2), valorKm)
                .input("valorKg", sql.Decimal(10, 2), valorKg)
                .input("valorTotal", sql.Decimal(10, 2), valorTotal)
                .query(querySQL);
    
        } catch (error) {
            console.error("Erro ao atualizar pedido:", error);
            throw error;
        }
    },

    deletarPedido: async (idPedido) => {
        const pool = await getConnection();
        const transaction = new sql.Transaction(pool);
        await transaction.begin();
    
        try {
            const querySQL = `
                DELETE FROM Pedidos
                WHERE idPedido = @idPedido
            `;
    
            await transaction.request()
                .input("idPedido", sql.UniqueIdentifier, idPedido)
                .query(querySQL);
    
            await transaction.commit();
        } catch (error) {
            await transaction.rollback();
            console.error("Erro ao deletar pedido:", error);
            throw error;
        }
    },
    
    
}
module.exports = { pedidoModel };